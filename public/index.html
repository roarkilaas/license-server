<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Management Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 5px; font-weight: 300; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; overflow-x: auto; }
        .nav-tab { padding: 15px 25px; background: none; border: none; cursor: pointer; font-size: 1em; color: #495057; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { background: white; color: #007bff; border-bottom-color: #007bff; }
        .tab-content { padding: 30px; min-height: 600px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.875em; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-group { display: flex; gap: 5px; }
        .data-table td:last-child { white-space: nowrap; min-width: 120px; }
        .action-buttons { display: flex; gap: 5px; justify-content: flex-start; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .data-table th { background: #f8f9fa; padding: 15px 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
        .data-table td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        .data-table tr:hover { background: #f8f9fa; }
        .data-container { max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        .form-container { background: #f8f9fa; padding: 25px; border-radius: 10px; margin: 20px 0; border: 1px solid #dee2e6; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #495057; }
        .form-control { padding: 12px 15px; border: 2px solid #ced4da; border-radius: 6px; font-size: 1em; }
        .form-control:focus { outline: none; border-color: #007bff; }
        .loading { text-align: center; padding: 40px; color: #6c757d; font-size: 1.1em; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #c3e6cb; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .nav-tabs { flex-direction: column; } .tab-content { padding: 20px 15px; } .btn-group { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è License Management Dashboard</h1>
            <p>Comprehensive license, customer, and product management system</p>
        </div>

        <!-- NAVIGATION -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('customers')">üë• Customers</button>
            <button class="nav-tab" onclick="showTab('products')">üì¶ Products</button>
            <button class="nav-tab" onclick="showTab('licenses')">üé´ Licenses</button>
        </nav>

        <div class="tab-content">
            <!-- CUSTOMERS -->
            <div id="customers" class="tab-pane active">
                <h3>Customer Management</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="showForm('customer')">‚ûï Add Customer</button>
                    <button class="btn btn-primary" onclick="loadCustomers()">üîÑ Refresh</button>
                </div>
                <div id="customerForm" class="form-container hidden">
                    <form onsubmit="createCustomer(event)">
                        <div class="form-row">
                            <div class="form-group"><label>ID</label><input type="text" id="customerId" class="form-control" required></div>
                            <div class="form-group"><label>Name</label><input type="text" id="customerName" class="form-control" required></div>
                            <div class="form-group"><label>Email</label><input type="email" id="customerEmail" class="form-control" required></div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">üíæ Save</button>
                            <button type="button" class="btn btn-secondary" onclick="hideForm('customer')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="customersData"><div class="loading">Loading customers...</div></div>
            </div>

            <!-- PRODUCTS -->
            <div id="products" class="tab-pane">
                <h3>Product Management</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="showForm('product')">‚ûï Add Product</button>
                    <button class="btn btn-primary" onclick="loadProducts()">üîÑ Refresh</button>
                </div>
                <div id="productForm" class="form-container hidden">
                    <form onsubmit="createProduct(event)">
                        <div class="form-row">
                            <div class="form-group"><label>ID</label><input type="text" id="productId" class="form-control" required></div>
                            <div class="form-group"><label>Name</label><input type="text" id="productName" class="form-control" required></div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">üíæ Save</button>
                            <button type="button" class="btn btn-secondary" onclick="hideForm('product')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="productsData"><div class="loading">Loading products...</div></div>
            </div>

            <!-- LICENSES -->
            <div id="licenses" class="tab-pane">
                <h3>License Management</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="showForm('license')">üé´ Create License</button>
                    <button class="btn btn-primary" onclick="loadLicenses()">üîÑ Refresh</button>
                </div>
                <div id="licenseForm" class="form-container hidden">
                    <form onsubmit="createLicense(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Product</label>
                                <select id="licenseProductId" class="form-control" required>
                                    <option value="">Select a product...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Customer</label>
                                <select id="licenseCustomerId" class="form-control" required>
                                    <option value="">Select a customer...</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Expiry Date</label><input type="date" id="licenseExpiryDate" class="form-control" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>License Type</label>
                                <select id="licenseLicenseType" class="form-control">
                                    <option value="machine">Machine</option>
                                    <option value="network">Network</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Max Activations</label><input type="number" id="licenseMaxActivations" class="form-control" value="1" min="1"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Features</label>
                                <div style="margin-bottom: 10px;">
                                    <button type="button" class="btn btn-success btn-sm" onclick="addFeature('scripting')" style="margin-right: 5px;">+ Scripting</button>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addFeature('reconstruction')" style="margin-right: 10px;">+ Reconstruction</button>
                                    <input type="text" id="customFeature" placeholder="Add custom feature..." style="display: inline-block; width: 150px; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 5px;">
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="addCustomFeature()">+ Add Custom</button>
                                </div>
                                <input type="text" id="licenseFeatures" class="form-control" placeholder="Features will appear here..." readonly>
                                <small style="color:#6c757d;">Click buttons above to add features, or clear and type manually if needed</small>
                                <div style="margin-top: 5px;">
                                    <button type="button" class="btn btn-warning btn-sm" onclick="clearFeatures()" style="margin-right: 5px;">Clear All</button>
                                    <button type="button" class="btn btn-info btn-sm" onclick="enableManualEdit()">Edit Manually</button>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">üé´ Create</button>
                            <button type="button" class="btn btn-secondary" onclick="hideForm('license')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="licensesData"><div class="loading">Loading licenses...</div></div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // First test basic connectivity
        try {
            console.log('Testing server connectivity...');
            const healthResponse = await fetch('/health');
            console.log('Health check status:', healthResponse.status);
            const healthData = await healthResponse.text();
            console.log('Health check response:', healthData);
        } catch (e) {
            console.error('Health check failed:', e);
        }
        
        loadCustomers();
    });

    function showTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'customers') loadCustomers();
        if (tabName === 'products') loadProducts();
        if (tabName === 'licenses') loadLicenses();
    }

    function showForm(type) {
        // Reset editing states when showing form for new records
        if (!editingCustomer && !editingProduct && !editingLicense) {
            const form = document.getElementById(type + 'Form');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            if (type === 'customer') {
                submitBtn.innerHTML = 'üíæ Save';
            } else if (type === 'product') {
                submitBtn.innerHTML = 'üíæ Save';
            } else if (type === 'license') {
                submitBtn.innerHTML = 'üé´ Create';
                // Load dropdown options for license form when creating new
                loadLicenseFormOptions();
                // Set default expiry date to 100 years from now (perpetual)
                setDefaultExpiryDate();
                // Reset features field
                clearFeatures();
                document.getElementById('licenseFeatures').readOnly = true;
                document.getElementById('licenseFeatures').placeholder = 'Features will appear here...';
            }
        }
        
        document.getElementById(type + 'Form').classList.remove('hidden');
    }

    // Load dropdown options for license form
    async function loadLicenseFormOptions() {
        try {
            // Load products
            const productsResponse = await fetch('/api/products');
            const products = await productsResponse.json();
            const productSelect = document.getElementById('licenseProductId');
            
            // Clear existing options except the first one
            productSelect.innerHTML = '<option value="">Select a product...</option>';
            
            if (Array.isArray(products)) {
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ${product.id}`;
                    productSelect.appendChild(option);
                });
            }
            
            // Load customers
            const customersResponse = await fetch('/api/customers');
            const customers = await customersResponse.json();
            const customerSelect = document.getElementById('licenseCustomerId');
            
            // Clear existing options except the first one
            customerSelect.innerHTML = '<option value="">Select a customer...</option>';
            
            if (Array.isArray(customers)) {
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} - ${customer.id}`;
                    customerSelect.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('Error loading form options:', error);
            showMessage('Error loading form options', 'error');
        }
    }

    // Set default expiry date to 100 years from now (perpetual license)
    function setDefaultExpiryDate() {
        const now = new Date();
        const oneHundredYearsFromNow = new Date(now.getFullYear() + 100, now.getMonth(), now.getDate());
        const dateString = oneHundredYearsFromNow.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        document.getElementById('licenseExpiryDate').value = dateString;
    }

    // ============ FEATURES MANAGEMENT ============
    function getCurrentFeatures() {
        const featuresText = document.getElementById('licenseFeatures').value.trim();
        if (!featuresText) return [];
        return featuresText.split(',').map(f => f.trim()).filter(f => f.length > 0);
    }

    function updateFeaturesDisplay(features) {
        document.getElementById('licenseFeatures').value = features.join(', ');
    }

    function addFeature(feature) {
        const currentFeatures = getCurrentFeatures();
        if (!currentFeatures.includes(feature)) {
            currentFeatures.push(feature);
            updateFeaturesDisplay(currentFeatures);
        }
    }

    function addCustomFeature() {
        const customInput = document.getElementById('customFeature');
        const customFeature = customInput.value.trim();
        
        if (customFeature) {
            const currentFeatures = getCurrentFeatures();
            if (!currentFeatures.includes(customFeature)) {
                currentFeatures.push(customFeature);
                updateFeaturesDisplay(currentFeatures);
            }
            customInput.value = ''; // Clear the input
        }
    }

    function clearFeatures() {
        document.getElementById('licenseFeatures').value = '';
    }

    function enableManualEdit() {
        const featuresField = document.getElementById('licenseFeatures');
        featuresField.readOnly = false;
        featuresField.focus();
        featuresField.placeholder = 'Enter features separated by commas...';
    }

    // Allow Enter key to add custom feature
    document.addEventListener('DOMContentLoaded', () => {
        const customFeatureInput = document.getElementById('customFeature');
        if (customFeatureInput) {
            customFeatureInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCustomFeature();
                }
            });
        }
    });

    function hideForm(type) {
        document.getElementById(type + 'Form').classList.add('hidden');
        // Reset editing states when hiding forms
        if (type === 'customer') {
            editingCustomer = null;
        } else if (type === 'product') {
            editingProduct = null;
        } else if (type === 'license') {
            editingLicense = null;
        }
    }

    function showMessage(msg, type) {
        const div = document.createElement('div');
        div.className = type;
        div.textContent = msg;
        document.querySelector('.tab-content').prepend(div);
        setTimeout(() => div.remove(), 3000);
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleString();
    }

    // ==== CUSTOMERS ====
async function loadCustomers() {
  try {
    console.log('Loading customers...');
    const r = await fetch('/api/customers');
    console.log('Response status:', r.status);
    
    if (!r.ok) {
      const errorText = await r.text();
      throw new Error(`HTTP ${r.status}: ${errorText}`);
    }
    
    const json = await r.json();
    console.log('Customers loaded:', json);
    
    if (json?.error) {
      throw new Error(json.error);
    }
    
    if (!Array.isArray(json)) {
      throw new Error('Invalid response format - expected array');
    }
    
    document.getElementById('customersData').innerHTML = `
      <div class="data-container">
        <table class="data-table">
          <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Actions</th></tr></thead>
          <tbody>
            ${json.map(c => `
              <tr>
                <td><code>${c.id ?? ''}</code></td>
                <td>${c.name ?? '-'}</td>
                <td>${c.email ?? '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editCustomer('${c.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteCustomer('${c.id}')">üóëÔ∏è</button>
                    </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  } catch (e) {
    console.error('Error loading customers:', e);
    document.getElementById('customersData').innerHTML =
      `<div class="error">Failed to load customers: ${e.message}</div>`;
  }
}
    async function createCustomer(e) {
        e.preventDefault();
        const data = {
            id: customerId.value, name: customerName.value, email: customerEmail.value
        };
        try {
            let res, result;
            if (editingCustomer) {
                // Update existing customer
                res = await fetch(`/api/customers/${editingCustomer.id}`, {
                    method:'PUT', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) { 
                    showMessage('Customer updated','success'); 
                    editingCustomer = null;
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            } else {
                // Create new customer
                res = await fetch('/api/customers', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) { 
                    showMessage('Customer added','success'); 
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            }
            
            if (res.ok) {
                hideForm('customer'); 
                loadCustomers();
                // Clear form and reset button text
                const form = document.getElementById('customerForm');
                form.querySelector('form').reset();
                form.querySelector('button[type="submit"]').innerHTML = 'üíæ Save';
            }
        } catch (err) {
            showMessage(`Error: ${err.message}`,'error');
        }
    }
    async function deleteCustomer(id) {
        try {
            const res = await fetch(`/api/customers/${id}`, {method:'DELETE'});
            const result = await res.json();
            if (res.ok) {
                showMessage('Customer deleted successfully','success'); 
                loadCustomers();
            } else {
                showMessage(`Error deleting customer: ${result.error}`,'error');
            }
        } catch (err) {
            showMessage(`Error deleting customer: ${err.message}`,'error');
        }
    }

    // ==== PRODUCTS ====
    async function loadProducts() {
    try {
        console.log('Loading products...');
        const r = await fetch('/api/products');
        console.log('Products response status:', r.status);
        
        if (!r.ok) {
            const errorText = await r.text();
            throw new Error(`HTTP ${r.status}: ${errorText}`);
        }
        
        const json = await r.json();
        console.log('Products loaded:', json);
        
        if (json?.error) {
            throw new Error(json.error);
        }
        
        if (!Array.isArray(json)) {
            throw new Error('Invalid response format - expected array');
        }
        
        document.getElementById('productsData').innerHTML = `
        <div class="data-container">
            <table class="data-table">
            <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
            <tbody>
                ${json.map(p => `
                <tr>
                    <td><code>${p.id ?? ''}</code></td>
                    <td>${p.name ?? '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editProduct('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteProduct('${p.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`).join('')}
            </tbody>
            </table>
        </div>`;
    } catch (e) {
        console.error('Error loading products:', e);
        document.getElementById('productsData').innerHTML =
        `<div class="error">Failed to load products: ${e.message}</div>`;
    }
    }
    async function createProduct(e) {
        e.preventDefault();
        const data = { id: productId.value, name: productName.value };
        try {
            let res, result;
            if (editingProduct) {
                // Update existing product
                res = await fetch(`/api/products/${editingProduct.id}`, {
                    method:'PUT', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) { 
                    showMessage('Product updated','success'); 
                    editingProduct = null;
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            } else {
                // Create new product
                res = await fetch('/api/products', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) {
                    showMessage('Product added','success'); 
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            }
            
            if (res.ok) {
                hideForm('product'); 
                loadProducts();
                // Clear form and reset button text
                const form = document.getElementById('productForm');
                form.querySelector('form').reset();
                form.querySelector('button[type="submit"]').innerHTML = 'üíæ Save';
            }
        } catch (err) {
            showMessage(`Error: ${err.message}`,'error');
        }
    }
    async function deleteProduct(id) {
        try {
            const res = await fetch(`/api/products/${id}`, {method:'DELETE'});
            const result = await res.json();
            if (res.ok) {
                showMessage('Product deleted successfully','success'); 
                loadProducts();
            } else {
                showMessage(`Error deleting product: ${result.error}`,'error');
            }
        } catch (err) {
            showMessage(`Error deleting product: ${err.message}`,'error');
        }
    }

    // ==== LICENSES ====
    async function loadLicenses() {
    try {
        console.log('Loading licenses...');
        const r = await fetch('/api/licenses');
        console.log('Licenses response status:', r.status);
        
        if (!r.ok) {
            const errorText = await r.text();
            throw new Error(`HTTP ${r.status}: ${errorText}`);
        }
        
        const json = await r.json();
        console.log('Licenses loaded:', json);
        
        if (json?.error) {
            throw new Error(json.error);
        }
        
        if (!Array.isArray(json)) {
            throw new Error('Invalid response format - expected array');
        }
        
        document.getElementById('licensesData').innerHTML = `
        <div class="data-container">
            <table class="data-table">
            <thead><tr><th>Key</th><th>Product</th><th>Customer</th><th>Type</th><th>Status</th><th>Features</th><th>Act.</th><th>Expires</th><th>Actions</th></tr></thead>
            <tbody>
                ${json.map(l => `
                <tr>
                    <td><code>${l.license_key}</code></td>
                    <td>${l.product_name || l.product_id}</td>
                    <td>${l.customer_name || l.customer_email || l.customer_id}</td>
                    <td><span class="badge ${l.license_type === 'machine' ? 'badge-info' : 'badge-success'}">${l.license_type || 'machine'}</span></td>
                    <td><span class="badge ${l.status === 'active' ? 'badge-success' : 'badge-danger'}">${l.status || 'active'}</span></td>
                    <td>${Array.isArray(l.features) && l.features.length > 0 
                        ? l.features.map(f => `<span class="badge badge-info">${f}</span>`).join(' ') 
                        : '<span class="badge" style="background:#f8f9fa;color:#6c757d;">none</span>'}</td>
                    <td>${(l.current_activations ?? 0)}/${(l.max_activations ?? 0)}</td>
                    <td>${formatDate(l.expiry_date)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editLicense('${l.license_key}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteLicense('${l.license_key}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`).join('')}
            </tbody>
            </table>
        </div>`;
    } catch (e) {
        console.error('Error loading licenses:', e);
        document.getElementById('licensesData').innerHTML =
        `<div class="error">Failed to load licenses: ${e.message}</div>`;
    }
    }
    async function createLicense(e) {
        e.preventDefault();
        
        // Parse features from comma-separated string
        const featuresStr = licenseFeatures.value.trim();
        const features = featuresStr ? featuresStr.split(',').map(f => f.trim()).filter(f => f.length > 0) : [];
        
        const data = { 
            product_id: licenseProductId.value, 
            customer_id: licenseCustomerId.value,
            expiry_date: licenseExpiryDate.value + 'T23:59:59.999Z',
            license_type: licenseLicenseType.value,
            max_activations: parseInt(licenseMaxActivations.value) || 1,
            features: features
        };
        try {
            let res, result;
            if (editingLicense) {
                // Update existing license
                res = await fetch(`/api/licenses/${editingLicense.license_key}`, {
                    method:'PUT', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) { 
                    showMessage('License updated','success'); 
                    editingLicense = null;
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            } else {
                // Create new license
                res = await fetch('/api/licenses', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(data)
                });
                result = await res.json();
                if (res.ok) {
                    showMessage(`License created: ${result.license_key}`,'success'); 
                } else {
                    showMessage(`Error: ${result.error}`,'error');
                }
            }
            
            if (res.ok) {
                hideForm('license'); 
                loadLicenses();
                // Clear form and reset button text
                const form = document.getElementById('licenseForm');
                form.querySelector('form').reset();
                form.querySelector('button[type="submit"]').innerHTML = 'üé´ Create';
                // Reset editing state
                editingLicense = null;
            }
        } catch (err) {
            showMessage(`Error: ${err.message}`,'error');
        }
    }
    async function deleteLicense(key) {
        try {
            const res = await fetch(`/api/licenses/${key}`, {method:'DELETE'});
            const result = await res.json();
            if (res.ok) {
                showMessage('License deleted successfully','success'); 
                loadLicenses();
            } else {
                showMessage(`Error deleting license: ${result.error}`,'error');
            }
        } catch (err) {
            showMessage(`Error deleting license: ${err.message}`,'error');
        }
    }

    // ============ EDIT FUNCTIONS ============
    let editingCustomer = null;
    let editingProduct = null; 
    let editingLicense = null;

    async function editCustomer(id) {
        try {
            // Find the customer data from the current list
            const response = await fetch('/api/customers');
            const customers = await response.json();
            const customer = customers.find(c => c.id === id);
            
            if (!customer) {
                showMessage('Customer not found', 'error');
                return;
            }
            
            editingCustomer = customer;
            
            // Populate the form with existing data
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name || '';
            document.getElementById('customerEmail').value = customer.email || '';
            
            // Change form title and button text
            const form = document.getElementById('customerForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'üíæ Update';
            
            // Show the form
            showForm('customer');
            
        } catch (err) {
            showMessage(`Error loading customer: ${err.message}`, 'error');
        }
    }

    async function editProduct(id) {
        try {
            const response = await fetch('/api/products');
            const products = await response.json();
            const product = products.find(p => p.id === id);
            
            if (!product) {
                showMessage('Product not found', 'error');
                return;
            }
            
            editingProduct = product;
            
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            
            const form = document.getElementById('productForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'üíæ Update';
            
            showForm('product');
            
        } catch (err) {
            showMessage(`Error loading product: ${err.message}`, 'error');
        }
    }

    async function editLicense(key) {
        try {
            const response = await fetch('/api/licenses');
            const licenses = await response.json();
            const license = licenses.find(l => l.license_key === key);
            
            if (!license) {
                showMessage('License not found', 'error');
                return;
            }
            
            editingLicense = license;
            
            // Load dropdown options first
            await loadLicenseFormOptions();
            
            // Then set the selected values
            document.getElementById('licenseProductId').value = license.product_id || '';
            document.getElementById('licenseCustomerId').value = license.customer_id || '';
            document.getElementById('licenseExpiryDate').value = license.expiry_date ? license.expiry_date.split('T')[0] : '';
            document.getElementById('licenseLicenseType').value = license.license_type || 'machine';
            document.getElementById('licenseMaxActivations').value = license.max_activations || 1;
            document.getElementById('licenseFeatures').value = Array.isArray(license.features) ? license.features.join(', ') : '';
            
            const form = document.getElementById('licenseForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'üíæ Update';
            
            showForm('license');
            
        } catch (err) {
            showMessage(`Error loading license: ${err.message}`, 'error');
        }
    }

    // ============ CONFIRMATION DIALOGS ============
    function confirmDeleteCustomer(id) {
        const message = `‚ö†Ô∏è DELETE CUSTOMER\n\n` +
                       `Customer ID: ${id}\n\n` +
                       `This will permanently delete the customer record.\n` +
                       `This action cannot be undone.\n\n` +
                       `Are you sure you want to continue?`;
        
        if (confirm(message)) {
            deleteCustomer(id);
        }
    }

    function confirmDeleteProduct(id) {
        const message = `‚ö†Ô∏è DELETE PRODUCT\n\n` +
                       `Product ID: ${id}\n\n` +
                       `This will permanently delete the product record.\n` +
                       `‚ö†Ô∏è WARNING: This may affect existing licenses!\n\n` +
                       `This action cannot be undone.\n\n` +
                       `Are you sure you want to continue?`;
        
        if (confirm(message)) {
            deleteProduct(id);
        }
    }

    function confirmDeleteLicense(key) {
        const message = `‚ö†Ô∏è DELETE LICENSE\n\n` +
                       `License Key: ${key}\n\n` +
                       `This will permanently delete the license and revoke access.\n` +
                       `This action cannot be undone.\n\n` +
                       `Are you sure you want to continue?`;
        
        if (confirm(message)) {
            deleteLicense(key);
        }
    }
</script>
</body>
</html>